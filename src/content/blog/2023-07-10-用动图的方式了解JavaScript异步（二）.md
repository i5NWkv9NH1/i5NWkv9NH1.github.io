---
title: ç”¨åŠ¨å›¾çš„æ–¹å¼äº†è§£ JavaScript å¼‚æ­¥ï¼ˆäºŒï¼‰
pubDatetime: 2023-07-10
tags:
  - JavaScript
---

## å‰è¨€

å›é¡¾ä¸Šä¸€ç¯‡æ–‡ç« äº†è§£åˆ°ï¼Œå¼‚æ­¥ç¼–ç¨‹å®é™…ä¸Šæ˜¯é€šè¿‡æ‰§è¡Œç¯å¢ƒï¼ˆä¾‹å¦‚æµè§ˆå™¨ã€Node.jsï¼‰æä¾›çš„ API æ¥å®ç°åŒæ—¶å¤„ç†å¤šä¸ªä»»åŠ¡çš„ã€‚

ç®€è€Œè¨€ä¹‹ï¼Œ**JavaScript å¼•æ“ä¸€æ¬¡åªèƒ½æ‰§è¡Œä¸€é¡¹ä»»åŠ¡ï¼Œä½†æ‰§è¡Œç¯å¢ƒæä¾›äº†æ–¹æ³•ï¼Œä½¿å¾— JavaScript å¯ä»¥ä»¥å¼‚æ­¥æ–¹å¼æ‰§è¡Œ**ã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€å•çš„é—®é¢˜ï¼Œæ¥æ£€æŸ¥ä¸€ä¸‹å¯¹ä¸Šä¸€ç¯‡æ–‡ç« çš„ç†è§£ï¼š

```ts
function cat() {
  console.log("ğŸ±");
}

function dog() {
  setTimeout(() => {
    console.log("ğŸ¶");
  }, 0);
}

function human() {
  console.log("âœ‹ğŸ»");
}

cat();
dog();
human();
```

ä»å­—é¢ä¸Šçš„é¡ºåºå’Œæ„ä¹‰æ¥çœ‹ï¼Œç»“æœåº”è¯¥æ˜¯ï¼šğŸ± > ğŸ¶ > âœ‹ğŸ»ï¼Œä½†å®é™…ä¸Šç­”æ¡ˆæ˜¯ï¼šğŸ± > âœ‹ğŸ» > ğŸ¶ã€‚

è¿™æ˜¯å› ä¸º dog å‡½æ•°ä¸­çš„ setTimeout æ˜¯**å¼‚æ­¥**çš„ï¼Œä¼šè¢«æ¨å…¥ Callback Queue ä¸­ç­‰å¾…å½“å‰ Call Stack ä¸Šçš„ä»»åŠ¡éƒ½æ‰§è¡Œå®Œä¹‹åæ‰ä¼šè¢«æ‰§è¡Œã€‚

åœ¨æ­¤ä¹‹å‰ï¼Œä¼šå…ˆç»§ç»­å®Œæˆå½“å‰ä¸»æ‰§è¡Œçº¿ç¨‹ä¸Šçš„ä»»åŠ¡ï¼Œæ‰€ä»¥å…ˆæ˜¯ âœ‹ğŸ»ï¼Œç„¶åæ‰æ˜¯ ğŸ¶ã€‚

![exam.gif](https://s2.loli.net/2024/02/25/9EYG4QnCroV1Ldi.gif)â€‹

## å®é™…çš„å¼‚æ­¥ç¨‹åº

å‰é¢çš„ä¾‹å­éå¸¸ç®€å•ï¼Œå¤§ä¸äº†å°±æ˜¯æŒ‡å®šä¸€æ®µä»£ç åœ¨ç‰¹å®šæ—¶é—´åè¿”å›å¤„ç†ï¼Œä½†å®é™…ä¼šé‡åˆ°çš„æƒ…å†µå¾€å¾€ä¼šå¤æ‚å¾—å¤šï¼Œå®é™…æ¡ˆä¾‹æ¥è¯´åƒæ˜¯ï¼š

- ç´¢å–ä¸ç¡®å®šå› ç´ ï¼ˆéœ€è¦ç­‰å¾…ä¸€æ®µæ—¶é—´ï¼‰çš„æ•°æ® (AJAX)
- å¤„ç†è€—æ—¶è´¹åŠ›çš„å·¥ä½œï¼Œé˜»å¡å…¶ä»–ç¨‹åºæ‰§è¡Œ (Thread Blocking)

é‡åˆ°è¿™äº›æƒ…å†µå°±å¿…é¡»è€ƒè™‘åˆ°é”™è¯¯æƒ…å¢ƒçš„å¤„ç†ã€ç¨‹åºçš„æ‰§è¡Œé¡ºåºçš„é—®é¢˜ï¼Œè¿™æ—¶å€™å°±éœ€è¦ä¸€ä¸ªå¥½çš„å¼‚æ­¥æ–¹å¼ï¼Œè®©ä»£ç æ›´å®¹æ˜“é˜…è¯»ã€ç»´æŠ¤ï¼Œä¹Ÿèƒ½æ›´æœ‰æ•ˆç‡åœ°å¤„ç†å¼‚æ­¥çš„ç¨‹åºã€‚

ä¸‰ç§å¸¸è§çš„å¼‚æ­¥å¤„ç†æ–¹æ³•ï¼Œç”±æµ…å…¥æ·±ï¼š

- å›è°ƒå‡½æ•°
- Promise ä¸å…¶æ–¹æ³•
- Async / Await

å®é™…ç¼–å†™å¹¶æå‡ºæ¯ç§æ–¹æ³•çš„ç‰¹ç‚¹ä»¥åŠè¦æ³¨æ„çš„åœ°æ–¹ã€‚æ¥ç€ä¼šç”¨ä»¥ä¸‹è¿™ä¸ªéå¸¸ç®€å•çš„ä¾‹å­ä½œä¸ºç¤ºä¾‹ï¼Œå¹¶å°è¯•ä¸åŒçš„å†™æ³•ã€‚

```ts
// è¯´æ˜ï¼šè¿™æ˜¯ä¸€ä¸ªåŒæ­¥çš„å‡½æ•°ï¼Œä½œç”¨æ˜¯è®¡ç®—æ­£æ–¹å½¢é¢ç§¯ (è¾¹é•¿ x è¾¹é•¿)
// åé¢éƒ½ä¼šä»¥è¿™ä¸ªç®€å•çš„ä¾‹å­ä½œä¸ºä»£ç ç¤ºä¾‹ï¼Œæ”¹å†™ä¸ºéåŒæ­¥ç¨‹åº
// éœ€æ±‚ï¼šè®¡ç®—æ­£æ–¹å½¢é¢ç§¯ï¼Œä½†æ˜¯è¦ç­‰ 1 ç§’åæ‰èƒ½å›ä¼ ç»“æœ

function getSquareArea(side) {
  return side * side;
}

getSquareArea(2); // 4
```

### å›è°ƒå‡½æ•° Callback

> "[å›è°ƒå‡½æ•°](https://developer.mozilla.org/zh-TW/docs/Glossary/Callback_function)" æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå°†å…¶ä½œä¸ºå‚æ•°ä¼ å…¥å¦å¤–ä¸€ä¸ªå‡½æ•°çš„æ—¶å€™å°±å¯ä»¥è¢«ç§°ä½œæ˜¯å›è°ƒå‡½æ•°ã€‚

ä¸ºä»€ä¹ˆè¦ä½¿ç”¨å›è°ƒå‡½æ•°å‘¢ï¼Ÿ

ä¸ºä»€ä¹ˆå­¦ä¹ å¼‚æ­¥å’Œå›è°ƒå‡½æ•°ç›¸å…³å‘¢ï¼Ÿ

æƒ³ä¸€æƒ³æˆ‘ä»¬ç»å¸¸ä½¿ç”¨çš„ `addEventListener`â€‹ æˆ– `setTimeout`â€‹ æ–¹æ³•ï¼Œå®ƒä»¬éƒ½æ˜¯å°†å¼‚æ­¥äº‹ä»¶çš„æ‰§è¡Œä»»åŠ¡åŒ…è£…ä¸ºä¸€ä¸ªå‡½æ•°ï¼Œå¹¶ä½œä¸ºå‚æ•°ä¼ é€’è¿›å»çš„ä¾‹å­ï¼š

```html
<button>ç‚¹å‡»æˆ‘è§¦å‘äº‹ä»¶ğŸ‘†ğŸ»</button>

<script>
  const button = document.querySelector("button");
  button.addEventListener("click", function (event) {
    console.log(event);
    alert(`ä½ ç‚¹å‡»äº†æŒ‰é’®ï¼è¯·æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°æŸ¥çœ‹ç»“æœã€‚`);
  });
</script>
```

é€šè¿‡å›è°ƒå‡½æ•°ï¼Œå¯ä»¥å°†éåŒæ­¥çš„ä»£ç åŒ…è£…ä¸ºå‡½æ•°ï¼Œå¹¶åœ¨éåŒæ­¥äº‹ä»¶å‘ç”Ÿåæ‰§è¡Œè¯¥å‡½æ•°ã€‚æ‹¿å‰é¢è®¡ç®—æ­£æ–¹å½¢é¢ç§¯çš„ç¨‹åºæ¥æ”¹å†™ï¼Œå½“æˆåŠŸæˆ–é”™è¯¯å°±ä¼šè¿”å›å¯¹åº”çš„ç»“æœåˆ°å›è°ƒå‡½æ•°å†…ï¼š

```ts
function getRectangleArea(side, callback) {
  // å®šä¹‰é”™è¯¯æƒ…å¢ƒ - éæ•°å­—
  if (typeof side !== "number") {
    callback(new TypeError("è¯·è¾“å…¥æ•°å­—"));
    return;
  }
  // å®šä¹‰é”™è¯¯æƒ…å¢ƒ - éæ­£æ•°
  if (side <= 0) {
    callback(new Error("è¯·è¾“å…¥æ­£æ•°"));
    return;
  }
  // æ‰§è¡ŒéåŒæ­¥è¡Œä¸ºï¼Œå¹¶ä¸”åœ¨éåŒæ­¥äº‹ä»¶å‘ç”Ÿåæ‰§è¡Œ callback
  setTimeout(() => callback(null, side ** 2), 1000);
}

getRectangleArea(2, (error, result) => {
  // å¦‚æœæœ‰é”™è¯¯ï¼Œå°±ä¼šåœ¨è¿™é‡Œè¢«æ•æ‰åˆ°
  if (error !== null) {
    console.error(error);
    return;
  }
  console.log(result);
});
```

è¿™å°±æ˜¯å›è°ƒå‡½æ•°çš„åŸºæœ¬æ¦‚å¿µï¼Œæ€»ç»“ä¸€ä¸‹å®ƒçš„ä¼˜ç¼ºç‚¹ï¼š

- **ä¼˜ç‚¹ï¼š**

  - ç›´æ¥ï¼Œæ˜“äºç†è§£ã€‚
  - ç»“æ„ç±»ä¼¼äºåŒæ­¥ä»£ç ã€‚

  **ç¼ºç‚¹ï¼š**

  - å¯èƒ½å¯¼è‡´å›è°ƒåœ°ç‹±ï¼ˆCallback Hellï¼‰ã€‚
  - æ§åˆ¶åè½¬ï¼ˆInversion of Controlï¼‰ã€‚
  - é£æ ¼ä¸ç»Ÿä¸€ï¼Œä»£ç æ˜“æ··ä¹±ã€‚

### Promise

> ã€Œ[PromiseğŸ”—](https://developer.mozilla.org/zh-TW/docs/Web/JavaScript/Reference/Global_Objects/Promise)ã€ æ˜¯ä¸€ä¸ªä»£è¡¨æœªæ¥å¯èƒ½å®Œæˆæˆ–å¤±è´¥çš„æ“ä½œçš„å¯¹è±¡ã€‚

ä¸ºäº†å…‹æœå›è°ƒå‡½æ•°çš„ç¼ºç‚¹ï¼ŒES6 å¼•å…¥äº† Promiseï¼Œå®ƒæä¾›äº†ä¸€ç§æ ‡å‡†åŒ–çš„æ–¹å¼æ¥å¤„ç†å¼‚æ­¥æ“ä½œã€‚Promise æœ‰ä¸‰ç§çŠ¶æ€ï¼š

- **çŠ¶æ€ï¼šä¸€ä¸ª Promise åªå¯èƒ½ä¼šæœ‰ä¸‰ç§çŠ¶æ€çš„å…¶ä¸­ä¸€ç§ï¼š**

  - `Pending`ï¼ˆå¾…å®šï¼‰ - åˆå§‹çŠ¶æ€ï¼Œæ“ä½œè¿˜æœªå®Œæˆã€‚

    `Fulfilled`ï¼ˆå·²å®Œæˆï¼‰ - æ“ä½œæˆåŠŸå®Œæˆã€‚

    `Rejected`ï¼ˆå·²æ‹’ç»ï¼‰ - æ“ä½œå¤±è´¥ã€‚

- **ç»“æœï¼šä¸€ä¸ª Promise åªå¯èƒ½ä¼šæœ‰ä¸¤ç§ç»“æœçš„å…¶ä¸­ä¸€ç§ï¼š**

  - `resolve`â€‹ - æˆåŠŸ
  - `reject`â€‹ - å¤±è´¥

å…ˆå†™ä¸€ä¸ªå…¨æ–°çš„ Promise æ¥äº†è§£çœ‹çœ‹ï¼š

```ts
// resolve ä¸ reject å¯è‡ªç”±å‘½å
const promise = new Promise((resolve, reject) => {
  // ä¸€äº›éåŒæ­¥çš„ä»£ç 
  if (/* åˆ¤æ–­ç»“æœ */){
    resolve(value);
  } else {
    reject(error);
  }
});
```

å¯ä»¥çœ‹è§ä¼ å…¥ Promise çš„å›è°ƒå‡½æ•°éœ€è¦ä¸¤ä¸ªå‚æ•°ï¼šæˆåŠŸæ—¶ä¸å¤±è´¥æ—¶è¯¥æ‰§è¡Œçš„å‡½æ•°åç§°ã€‚æˆ‘ä»¬å¯ä»¥è½»æ˜“çš„åœ¨è¿™ä¸ª Promise ä¸­å®šä¹‰æˆåŠŸä¸å¤±è´¥çš„æ¡ä»¶ï¼Œåƒä»¥ä¸‹ä»£ç ä¸­åªéœ€è¦åœ¨æˆåŠŸæ—¶è¿”å› resolveï¼Œå¤±è´¥æ—¶è¿”å› reject å°±å¯ä»¥äº†ï¼š

```ts
// Promise ä¼šåœ¨ 1 ç§’åè¿”å›ç»“æœï¼Œå¦‚æœå‡ºé”™å°±ä¼šè¿”å›å¤±è´¥ï¼ŒæˆåŠŸå°±è¿”å›ç»“æœ
function getRectangleArea(side) {
  return new Promise((resolve, reject) => {
    // rej
    if (typeof side !== "number") {
      reject(new TypeError("è¯·è¾“å…¥æ•°å­—"));
      return;
    }
    // rej
    if (side <= 0) {
      reject(new Error("è¯·è¾“å…¥æ­£æ•°"));
      return;
    }
    // res
    setTimeout(() => {
      resolve(side ** 2);
    }, 1000);
  });
}
```

ç°åœ¨æˆåŠŸçš„æŠŠå›å‘¼å‡½æ•°æ”¹ä¸ºä½¿ç”¨ Promise äº†ï¼Œä½†æ‹¿åˆ°äº† Promise ä¹‹åè¯¥å¦‚ä½•ä½¿ç”¨å‘¢ï¼Ÿç›´æ¥åŒæ­¥çš„å»ä½¿ç”¨ Promise å—ï¼Ÿ

ç­”æ¡ˆæ˜¯ä¸è¡Œçš„ï¼Œå› ä¸ºå½“éåŒæ­¥è¡Œä¸ºæ‰§è¡Œæ—¶çš„å½“ä¸‹ Promise çš„çŠ¶æ€ä¼šæ˜¯ Pendingï¼Œç›´æ¥å­˜å– Promise æ˜¯æ²¡åŠæ³•å°†éœ€è¦ç­‰å¾…å®Œæˆçš„å€¼ç»™å–å‡ºæ¥çš„ã€‚

```ts
// æ— æ³•åœ¨åŒæ­¥ä¸‹ç›´æ¥è°ƒç”¨ Promise
// ä¼šè¾“å‡º <Pending>
console.log(getRectangleArea(2));
```

#### å¦‚ä½•å–å¾— Promise çš„è¿”å›å€¼ï¼Ÿ

å¯ä»¥ä½¿ç”¨ Promise.then æ–¹æ³•å»åº”å¯¹è¯¥ Promise æ‰§è¡Œå®ŒåæˆåŠŸä¸å¤±è´¥çš„æƒ…å¢ƒï¼š

```ts
Promise.then(success, error);
```

æ›´å¸¸è§è¿˜æ˜¯ä¼šä½¿ç”¨ .catch æ¥æ•æ‰é”™è¯¯çš„æƒ…å¢ƒï¼Œå®ƒä»¬ä¹‹é—´ç»†èŠ‚ä¸Šæœ‰ä¸€äº›ä¸åŒï¼Œä¸è¿‡ä½¿ç”¨ .catch çš„æ–¹æ³•ä¼šæ¯”è¾ƒå…¨é¢ä¸”ç›´è§‚ï¼Œå»ºè®®ç»å¤§å¤šæ—¶å€™è¿™æ ·å†™å³å¯ï¼š

```ts
Promise.then(success).catch(error);
```

æ¢ä¸Šå‰é¢è®¾å®šå¥½çš„é¢˜ç›®å°±å¯ä»¥ç”¨è¿™æ ·çš„æ–¹å¼å¤„ç† getRectangleArea è¿™ä¸ªå‡½å¼å›ä¼ çš„ Promise ç‰©ä»¶ï¼š

```ts
getRectangleArea(2)
  .then(result => {
    console.log(result);
  })
  .catch(error => {
    console.error(error);
  });
```

è¿™å°±æ˜¯ Promise çš„åŸºæœ¬æ¦‚å¿µï¼Œæ¥æ€»ç»“ä¸€ä¸‹ Promise çš„ç‰¹ç‚¹ï¼š

- **ä¼˜ç‚¹ï¼š**

  - æ›´æ¸…æ™°çš„ä»£ç ç»“æ„ã€‚
  - ç»Ÿä¸€çš„é”™è¯¯å¤„ç†ã€‚
  - æä¾›äº†è®¸å¤šå¤„ç†å¼‚æ­¥æ“ä½œçš„æ–¹æ³•ï¼Œå¦‚ `Promise.all`ã€‚

  **ç¼ºç‚¹ï¼š**

  - åªèƒ½å¤„ç†ä¸€ä¸ªç»“æœã€‚
  - æ—§æµè§ˆå™¨ä¸æ”¯æŒã€‚

### Async / Await

> ã€Œ[Async / Await](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Statements/async_function)ã€æ˜¯ä¸€ä¸ªè¯­æ³•ç³–ï¼Œèƒ½å¤Ÿå†™å‡ºåŒæ­¥é£æ ¼çš„å¼‚æ­¥ä»£ç ã€‚

**Async / Await** æ˜¯åœ¨ Promise åŸºç¡€ä¸Šå¼•å…¥çš„è¯­æ³•ç³–ï¼Œå¯ä»¥è®©å¼‚æ­¥ä»£ç çœ‹èµ·æ¥åƒåŒæ­¥ä»£ç ã€‚

#### Async

async å…³é”®å­—å¯ä»¥è®© JavaScript å¼•æ“äº†è§£ç›®å‰æ­£åœ¨ç¼–å†™ä¸€ä¸ªå¼‚æ­¥çš„å‡½æ•°ï¼Œå¹¶ä¸”è®©æ•´ä¸ªå‡½æ•°å›è°ƒä¸€ä¸ª Promiseã€‚

#### Await

await å…³é”®å­—ä»…èƒ½åœ¨ async å‡½æ•°å†…éƒ¨ä½¿ç”¨ï¼Œå°†å…¶æ”¾ç½®åœ¨ Promise ä¹‹å‰ï¼Œå®ƒå¯ä»¥å¸®åŠ©æˆ‘ä»¬ç­‰å¾… Promise çš„è§£å†³ï¼Œå¹¶å–å¾—å…¶å€¼ã€‚

```ts
async function asyncFunction() {
  const value = await getRectangleArea(2);
}
```

è¿˜å¯ä»¥åŠ ä¸Š [tryâ€¦catch è¯­æ³•](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Statements/try...catch) å»æ•æ‰é”™è¯¯ï¼Œå†™èµ·ä¾†å·²ç¶“éå¸¸åƒåŒæ­¥ä»£ç äº†ï¼š

```ts
async function calcRectangleArea(side) {
  const rectangleArea = await new Promise((resolve, reject) => {
    if (typeof side !== "number") {
      reject(new TypeError("è¯·è¾“å…¥æ•°å­—"));
      return;
    }
    if (side <= 0) {
      reject(new Error("è¯·è¾“å…¥æ­£æ•°"));
      return;
    }
    setTimeout(() => resolve(side ** 2), 5000);
  });
  console.log(rectangleArea);
}

calcRectangleArea(4);
```

## è¯¥ä½¿ç”¨å“ªç§æ–¹å¼å¤„ç†éåŒæ­¥ï¼Ÿ

ç«¯çœ‹å›¢é˜Ÿä¸ä¸ªäººåå¥½ï¼Œå¹¶æ²¡æœ‰ä¸€å®šå¯¹é”™çš„ç­”æ¡ˆã€‚å¯¹æˆ‘æ¥è¯´ï¼Œå¦‚æœæ²¡æœ‰åŒ…è¢±ï¼ˆç‰ˆæœ¬é—®é¢˜ã€ç»´æŠ¤é—ç•™ä»£ç ï¼‰å°±ç”¨ **Promise + Async / Await** å³å¯ï¼Œä¿æŒè¯­æ³•ç®€æ´ä¸”ä½¿ç”¨ä¸Šä¹Ÿæ›´ä¸ºç›´è§‚ä¸ä¸€è‡´ï¼Œå‰ææ˜¯æœ€å¥½ç†è§£äº†éåŒæ­¥çš„æ¦‚å¿µå†ä½¿ç”¨ä¼šæ›´å¥½ã€‚

### å¯ä»¥æ··ç”¨å›è°ƒå‡½æ•°ã€Promise.then()ã€Async / Await å—ï¼Ÿ

å¯ä»¥ï¼Œä½†æœ€å¥½ä¸è¦ã€‚åº”å½“ç»Ÿä¸€æ–¹æ³•é¿å…é€ æˆä¸å¿…è¦çš„~~æ··ä¹±~~ï¼ˆåœ£æˆ˜ï¼‰ã€‚

## å‚è€ƒèµ„æ–™

- [éåŒæ­¥çš„ JavaScript ä»‹ç»](https://developer.mozilla.org/zh-TW/docs/Learn/JavaScript/Asynchronous/Introducing)
- [Why Do We Need Javascript Promises? Inversion of Control | Asynchronous Javascript | Project Twine](https://www.youtube.com/watch?v=bAlczbDUXx8)
- [JavaScript Promisesï¼šç®€ä»‹](https://web.dev/i18n/zh/promises)

â€
