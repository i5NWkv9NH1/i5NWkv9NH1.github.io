---
title: JavaScript 的计时器是否精确？
pubDatetime: 2023-06-18
tags:
  - JavaScript
---

## 前言

在日常开发中，我们经常使用 `setTimeout` 和 `setInterval` 来设置定时任务或循环任务。然而，你是否曾想过，这些计时器的时间真的那么准确吗？

## 原因分析

### 硬件

首先，我们来看看硬件层面。这个世界上有没有完全精确的计时？答案是否定的。绝对精确的计时在现实中是不存在的（这甚至涉及到一个关于时间本质的哲学问题）。但我们可以实现相对精确的计时。比如，最精确的计时工具是原子钟，它是通过原子的共振频率来计时的，非常精准。

然而，我们的计算机硬件并不是原子钟。计算机依赖于内部的时钟信号，通过寄存器来计时。这些寄存器的精度远不如原子钟，因此在硬件层面上，计算机的计时精度是有限的。硬件上的这些微小误差直接影响了 JavaScript 计时器的精确性。

### 操作系统

JavaScript 代码在浏览器中执行，但最终所有的计时操作都会交给操作系统来处理。也就是说，当你在代码中使用 `setTimeout` 或 `setInterval` 时，浏览器并不会自己计时，而是将计时任务委托给操作系统。这就引出了一个问题：不同的操作系统对计时的处理方式不同，因此计时精度也会有所差异。

操作系统在进行多任务调度时，会使用时间片来切换任务。计时器在某个时间片中被分配到的时间可能会有微小的误差。因此，不同的操作系统、甚至不同的版本和设置，都会对 JavaScript 计时器的精确性产生影响。

### 标准

JavaScript 是基于 W3C 和 ECMAScript（ES）标准来开发的。但值得注意的是，`setTimeout` 和 `setInterval` 并不是 JavaScript 语言本身的标准，而是浏览器的环境标准。根据 W3C 的规定，当一个计时器嵌套层次达到 5 层或更多时，最小的计时间隔必须是 4 毫秒。这意味着即使你在代码中设置了 1 毫秒或 0 毫秒的计时器，一旦嵌套过多，最小的计时精度也会被限制在 4 毫秒。

这个标准的存在是为了避免计时器陷入无限循环，消耗过多的系统资源。在一些需要精确计时的场景下，比如动画帧的控制，这样的限制会导致计时器的表现不如预期。

### 事件循环

JavaScript 的事件循环机制也会影响计时器的精确性。JavaScript 是单线程的，所有的任务都在一个执行栈中排队执行。当你设置了一个计时器，比如 10 毫秒的 `setTimeout`，它不会在 10 毫秒后立即执行，而是要等到当前的执行栈清空后才能执行。

如果在计时器到点的那一刻，执行栈中还有其他任务在运行，计时器就只能等待，直到这些任务完成。这样一来，计时器的实际执行时间就会超过设定的时间。所以，即使你设定了 10 毫秒的计时器，实际的执行时间可能会远远大于 10 毫秒。
