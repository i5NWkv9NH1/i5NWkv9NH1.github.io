---
title: æ¶ˆé™¤å¼‚æ­¥çš„ä¼ æŸ“æ€§ï¼šç®€å•ç†è§£å’Œè§£å†³æ–¹æ³•
---

## å‰è¨€

åœ¨ JavaScript ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸éœ€è¦å¤„ç†å¼‚æ­¥æ“ä½œï¼Œæ¯”å¦‚é€šè¿‡ `fetch` å‘é€ç½‘ç»œè¯·æ±‚ã€‚ä½†æ˜¯ï¼Œè¿™äº›å¼‚æ­¥æ“ä½œæœ‰ä¸€ä¸ªç‰¹ç‚¹ï¼Œé‚£å°±æ˜¯å®ƒä»¬ä¼šâ€œä¼ æŸ“â€â€”â€”å¦‚æœä¸€ä¸ªå‡½æ•°æ˜¯å¼‚æ­¥çš„ï¼Œé‚£ä¹ˆæ‰€æœ‰è°ƒç”¨å®ƒçš„å‡½æ•°ä¹Ÿå¿…é¡»æ˜¯å¼‚æ­¥çš„ã€‚è¿™ç§æƒ…å†µå¯èƒ½ä¼šè®©æ•´ä¸ªç¨‹åºå˜å¾—å¤æ‚ã€‚

```ts
async function getUser() {
  return await fetch('./1.json')
}

async function m1() {
  const user = await getUser()
  return user
}

async function m2() {
  const user = await m1()
  return user
}

async function m3() {
  const user = await m2()
  return user
}

async function main() {
  const user = await m3()
	console.log(user)
}
```

åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæœ€å¼€å§‹çš„ `getUser` å‡½æ•°æ˜¯å¼‚æ­¥çš„ï¼Œå› ä¸ºå®ƒä½¿ç”¨äº† `fetch`ï¼Œå¯¼è‡´ `m1`ã€`m2`ã€`m3` ä»¥åŠ `main` ä¹Ÿéƒ½æˆäº†å¼‚æ­¥å‡½æ•°ã€‚ğŸ˜« è¿™å°±åƒå¤šç±³è¯ºéª¨ç‰Œä¸€æ ·ï¼Œä¸€å€’å…¨å€’ã€‚è¿™åœ¨ä¸€äº›åœºæ™¯ä¸­å¯èƒ½ä¼šå¢åŠ ä»£ç çš„å¤æ‚åº¦ï¼Œä¹Ÿè¿åäº†å‡½æ•°å¼ç¼–ç¨‹ä¸­å…³äºâ€œçº¯å‡½æ•°â€çš„åŸåˆ™ã€‚

## åŸå› åˆ†æ

é—®é¢˜çš„æ ¹æºåœ¨äº `getUser` å‡½æ•°ï¼Œå®ƒä½¿ç”¨äº† `fetch` å‘é€ç½‘ç»œè¯·æ±‚ã€‚ç½‘ç»œè¯·æ±‚æ˜¯å¼‚æ­¥çš„ï¼Œæ„å‘³ç€æˆ‘ä»¬ä¸èƒ½ç«‹åˆ»å¾—åˆ°ç»“æœã€‚ä¸ºäº†é¿å…é˜»å¡æµè§ˆå™¨çš„ä¸»çº¿ç¨‹ï¼ŒJavaScript é€‰æ‹©åœ¨åå°å¤„ç†è¯·æ±‚ï¼Œè€Œè¿™æ®µæ—¶é—´é‡Œç»§ç»­æ‰§è¡Œå…¶ä»–ä»£ç ã€‚

ä½†è¿™ä¹Ÿæ„å‘³ç€ä»»ä½•ä¾èµ– `getUser` ç»“æœçš„å‡½æ•°å¿…é¡»ç­‰å¾…å®ƒå®Œæˆï¼Œè¿›è€Œå˜æˆäº†å¼‚æ­¥å‡½æ•°ã€‚

![](https://s2.loli.net/2024/08/28/mC1MtPA9pDLEkiy.png)

å¦‚å›¾æ‰€ç¤ºï¼Œè¿™æ˜¯å‡½æ•°çš„è°ƒç”¨æ—¶é—´çº¿ã€‚ç”±äº `fetch` éœ€è¦ç­‰å¾…ï¼Œé‚£ä¹ˆ `getUser` ä¹Ÿéœ€è¦ç­‰å¾…ï¼Œä»è€Œ `mian` å‡½æ•°ä¹Ÿéœ€è¦ç­‰ã€‚é‚£ä¹ˆæœ€ç»ˆåªèƒ½åœ¨ `fetch` åšæ–‡ç« ã€‚

## è§£å†³æ–¹æ¡ˆ

æˆ‘ä»¬çš„ç›®æ ‡æ˜¯è®©è¿™äº›å‡½æ•°çœ‹èµ·æ¥åƒåŒæ­¥çš„ï¼Œä½†åˆä¸èƒ½çœŸçš„é˜»å¡æµè§ˆå™¨ä¸»çº¿ç¨‹ã€‚ä¸€ä¸ªæ–¹æ³•æ˜¯åˆ©ç”¨ç¼“å­˜æœºåˆ¶ï¼šåœ¨ç¬¬ä¸€æ¬¡è°ƒç”¨ `fetch` æ—¶ï¼Œç«‹å³å‘å‡ºè¯·æ±‚ï¼Œä½†ä¸ç­‰å¾…ç»“æœï¼Œè€Œæ˜¯æŠ›å‡ºä¸€ä¸ªé”™è¯¯ã€‚ä¸‹ä¸€æ¬¡è°ƒç”¨æ—¶ï¼Œå¦‚æœæœ‰ç¼“å­˜ï¼Œå°±ç«‹åˆ»è¿”å›ç¼“å­˜ç»“æœã€‚

![](https://s2.loli.net/2024/08/28/tAZXdEjNwBil8zn.png)

åœ¨è¿™ç§å®ç°ä¸­ï¼Œ`fetch` å‡½æ•°ä¸ä¼šç­‰å¾…è¯·æ±‚å®Œæˆï¼Œè€Œæ˜¯ç«‹å³æŠ›å‡ºä¸€ä¸ªé”™è¯¯ã€‚å°½ç®¡ `main` å‡½æ•°å› æ­¤å‡ºé”™å¹¶ä¸­æ–­æ‰§è¡Œï¼Œä½†ç½‘ç»œè¯·æ±‚å·²ç»å‘å‡ºï¼Œä¸ä¼šè¢«å–æ¶ˆã€‚å½“è¯·æ±‚æˆåŠŸåï¼Œæˆ‘ä»¬å¯ä»¥å°†ç»“æœç¼“å­˜èµ·æ¥ï¼ˆå³ä¸Šä¸€æ¬¡è¯·æ±‚çš„ç»“æœï¼‰ï¼Œç„¶åé‡æ–°å¼€å§‹æ•´ä¸ªè°ƒç”¨é“¾ï¼Œä»å¤´å†æ‰§è¡Œä¸€æ¬¡ `main` å‡½æ•°ï¼ˆæ³¨æ„ï¼Œè¿™æ¬¡æ‰§è¡Œçš„ `main` å·²ç»ä¸æ˜¯ç¬¬ä¸€æ¬¡çš„ `main`ï¼Œè€Œæ˜¯é‡æ–°è¿è¡Œåçš„ç‰ˆæœ¬ï¼‰ã€‚

é‡æ–°æ‰§è¡Œ `main` å‡½æ•°åï¼Œå®ƒä¼šå†æ¬¡è°ƒç”¨ `fetch`ã€‚è¿™ä¸€æ¬¡ï¼Œå› ä¸ºç»“æœå·²ç»ç¼“å­˜ï¼Œ`fetch` å¯ä»¥ç«‹å³è¿”å›ç»“æœè€Œæ— éœ€ç­‰å¾…ã€‚è¿™æ ·ä¸€æ¥ï¼Œå‡½æ•°è°ƒç”¨é“¾å°±å˜æˆäº†åŒæ­¥æ“ä½œã€‚è™½ç„¶æ•´ä¸ªè¿‡ç¨‹éœ€è¦ç»å†ä¸¤æ¬¡è°ƒç”¨ï¼Œä½†ç¬¬ä¸€æ¬¡çš„é”™è¯¯å¤„ç†ä¿è¯äº†æœ€ç»ˆçš„åŒæ­¥æ•ˆæœï¼Œç¬¬äºŒæ¬¡è°ƒç”¨å¯ä»¥é¡ºåˆ©ç»“æŸè€Œä¸å†ç­‰å¾…å¼‚æ­¥æ“ä½œã€‚

### é‡å†™ Fetch é€»è¾‘

![](https://s2.loli.net/2024/08/28/JkaPb34xKhVG68d.png)

å½“è°ƒç”¨ `fetch` è¯·æ±‚å‡½æ•°æ—¶ï¼Œé¦–å…ˆæ£€æŸ¥æ˜¯å¦æœ‰ç¼“å­˜çš„ç»“æœã€‚å¦‚æœæœ‰ç¼“å­˜ï¼Œç›´æ¥è¿”å›ç¼“å­˜ä¸­çš„ç»“æœï¼Œè¿™æ ·å°±ä¸éœ€è¦ç­‰å¾…æ–°çš„è¯·æ±‚äº†ã€‚å¦‚æœæ²¡æœ‰ç¼“å­˜ï¼Œå°±ç«‹å³å‘é€è¯·æ±‚ï¼Œå¹¶ç”¨ `Promise` å°†è¯·æ±‚çš„ç»“æœå†™å…¥ç¼“å­˜ï¼Œä½†åŒæ—¶ä¸ç­‰å¾…è¿™ä¸ªè¯·æ±‚çš„å®Œæˆï¼Œè€Œæ˜¯ç«‹åˆ»æŠ›å‡ºä¸€ä¸ªé”™è¯¯ã€‚

åœ¨è¿™ç§æœºåˆ¶ä¸‹ï¼Œä¸‹æ¬¡è°ƒç”¨ `fetch` æ—¶ï¼Œå¦‚æœç¼“å­˜ä¸­å·²ç»æœ‰ç»“æœï¼Œå°±å¯ä»¥ç›´æ¥è¿”å›ç¼“å­˜çš„ç»“æœï¼Œå®ç°åŒæ­¥æ“ä½œçš„æ•ˆæœã€‚

```ts
function run(func) {
  let cache = {
    status: 'pending',  // çŠ¶æ€ï¼špending, fulfilled, rejected
    value: null
  }
  const oldFetch = window.fetch
  
  window.fetch = function(...args) {
    if (cache.status === 'fulfilled') {
      // å¦‚æœæœ‰ç¼“å­˜ï¼Œç›´æ¥è¿”å›ç¼“å­˜çš„ç»“æœ
      return cache.value
    } else if (cache.status === 'rejected') {
      // å¦‚æœæœ‰ç¼“å­˜ï¼Œä½†è¯·æ±‚å¤±è´¥ï¼ŒæŠ›å‡ºé”™è¯¯
      throw cache.value
    }
    
    // ç¬¬ä¸€æ¬¡è¯·æ±‚ï¼Œå‘å‡ºè¯·æ±‚å¹¶ç¼“å­˜ç»“æœ
    const _promise = oldFetch(...args).then(res => {
      cache.status = 'fulfilled'
      cache.value = res
    }, error => {
      cache.status = 'rejected'
      cache.value = error
    })
    
    // ç«‹å³æŠ›å‡ºé”™è¯¯
    throw _promise
  }
  
  // å¤„ç†ç¬¬ä¸€æ¬¡æŠ›å‡ºçš„é”™è¯¯ï¼Œé‡è¯•è¯·æ±‚
  try {
    func()
  } catch (error) {
    if (error instanceof Promise) {
      error.then(func, func).finally(() => {
        window.fetch = oldFetch  // æ¢å¤åŸå§‹ fetch æ–¹æ³•
      })
    }
  }
}

run(main)

```

